# 挖矿难度

挖矿就是不断尝试 block header 里的 nonce 值，使 H(block header) <= target，target 越小，难度越大。调整挖矿难度就是调整目标空间在整个输出空间中所占的比例。



比特币用的哈希算法是 SHA-256，这个产生的哈希值是 256 位。所以整个输出空间是 2 的 256 次方。调整这个比例，即目标空间占输出空间的比例，通俗的说，就是哈希值前面要有多少个 0。比如说 256 位的哈希值，要是合法的区块，要求算出来的哈希，前面至少有 70 个 0。



挖矿的难度跟目标阈值是成反比的，公式是：difficulty = difficulty_1_target / target（difficulty_1_target 是指挖矿难度等于 1 的时候所对应的目标阈值，挖矿难度最小就是 1，这个时候对应的目标阈值是个非常大的数）。

## 为什么要调整挖矿难度

为什么要调整挖矿难度？系统里的总算力越来越强，挖矿难度保持不变的话，出块时间是越来越短的。出块时间太小有什么问题？

比如说不到 1 秒就出一个区块，区块在网络上传播的时间可能需要几十秒，底层的比特币网络可能需要几十秒才能让其他节点都收到。别的节点没有收到这个区块之前还是继续沿着已有的区块链往下扩展。如果有两个节点同时都发布一个区块，这个时候就会出现分岔。

因此==出块时间短会导致**分叉会非常频繁**，而且会出现多分叉，对系统达成共识不好，安全性也不好。==



==分叉多了以后，**算力分散**，**分叉攻击更容易**。有恶意的节点可以集中算力在分叉链上扩展，不需要 51% 的算力就可以发动攻击。==

<img src="https://littleneko.oss-cn-beijing.aliyuncs.com/img/image-20221017233343216.png" alt="image-20221017233343216" style="zoom:25%;" />



那 10 分钟的出块时间是不是最优的呢？不一定，改成其他值也可以，有间隔只是说应该有个常数范围。以太坊出块时间 15s，出块时间大幅度下降之后，以太坊就要设计新的协议，叫 ghost。

> 在 ghost 协议中，这些分叉产生的 orphan block（即产生最长合法链后另一个要被丢弃的区块）就不能丢弃掉了，而是也要给它们一些奖励，这叫 uncle reward。以太坊也要调整挖矿难度，使出块时间保持在 15s。

## 如何调整挖矿难度

比特币中每 2016 个区块需要调整一次难度，即 (2016 x 10) / (60 x 24) = 14 天，调整公式是：

new_target = target x (actual_time / expected_time) （有最大 4 倍限制，和最小 1/4 限制）



* 如何让所有矿工同时调整难度？

  规则写在代码里，每过 2016 个区块就会自动调整。

* 如果有恶意节点修改代码不调整怎么办？

  header 中有 nBits 表示 target，其他节点会这个区块式非法的，不会接受。



# 挖矿

## 全节点 和 轻节点

**全节点**

* 一直在线
* 在本地硬盘上维护完整的区块链信息
* 在内存里维护UTXO集合，以便快速检验交易的正确性
* 监听比特币网络上的交易信息，验证每个交易的合法性
* 决定哪些交易会被打包到区块里
* 监听别的矿工挖出来的区块，验证其合法性
* 挖矿
  * 决定沿着哪条链挖下去？
  * 当出现等长的分叉的时候，选择哪一个分叉？

**轻节点**

* 不是一直在线
* 不用保存整个区块链，只要保存每个区块的块头
* 不用保存全部交易，只保存与自己相关的交易
* 无法检验大多数交易的合法性，只能检验与自己相关的那些交易的合法性。
* 无法检测网上发布的区块的正确性
* 可以验证挖矿的难度
* 只能检测哪个是最长链，不知道哪个是最长合法链

ppt：http://zhenxiao.com/blockchain/08-BTC.pdf



如果在挖矿过程中收到一个区块，且是合法的并且在延伸最长合法链，应该停止现在正在挖的区块，然后重新在本地组装一个候选区块，然后开始重新挖矿。因为要沿着新收到的最长合法链挖，本地区块可能会发生变化，因为==有些区块可能已经被包含在这个最新的最长合法链中了==，而且 block header 中的 ==previous block hash== 和 ==默克尔树的根 hash 值== 都会发生变化。



==放弃已经在挖的区块，重新去挖新的区块，前面做的工作都白费了，很不划算？==

==计算 hash 值的无记忆性，实际上不会有影响，只要没挖出来，期望挖到的时间仍然是 10 分钟。==



**比特币如何保证安全性**

1. 密码学上保证，无法伪造签名，没有私钥签名不能花掉 BTC（系统中大多数矿工是诚实的）
2. 共识机制



## 挖矿设备

1. 通用设备（CPU）：只用到整数运算，内存等都没怎么用到
2. GPU：并行计算能力强，仍然只用到整数运算，其他的部件浪费
3. ASIC：专用芯片，为某个（几个）加密货币设计，不通用 mining puzzle。有些加密货币刚发行的时候，为了解决能启动问题，会故意用一个已有的加密货币的 mining puzzle，比如说跟比特币一样的 mining puzzle，这样可以吸引更多的人来挖矿，这种情况叫 merge mining。除了这种情况，其他都是一个芯片只能为一个加密货币挖矿。ASIC芯片生产周期需要一年，但跟其他通用芯片相比，ASIC芯片研发速度已经是非常快的了。

挖矿机的变化趋势，是从通用变得越来越专用，CPU 是通用计算，GPU 是通用并行计算，ASIC 是专用计算。ASIC 一旦过时就作废了，不像 CPU 和 GPU 还能做其他工作。很多人觉得这是不好的，是跟去中心化的理念是不相符的，也违背了比特币设计的初衷。最好的情况是，大家都用家里的 CPU 计算机挖矿。而有些新的加密货币设计的是 Alternative mining puzzle。而设计它的出发点是 asic resistance（抗 asic 芯片化），目的是让通用的计算机也能参与挖矿的过程。



## 矿池

挖矿的另一个趋势是大型矿池的出现，单个矿工即使用了 ASIC 芯片，挖矿从平均收益上看是有利可图的，但是收入是非常不稳定的。比特币系统中平均每 10 分钟出一个区块，这是说比特币系统中所有的矿工做一个整体来看平均 10 分钟会产生一个区块。==但如果具体到某一个矿工来说，他可能要挖很长时间，如果他用一个矿机可能要挖一两年，就好像是买彩票，挖到了就是中了一个大奖，挖不到所有工作就都白费了。==

所以要引入矿池，所谓的矿池，就是把这些矿工组织起来，作为一个整体，矿池的架构一般是一个全节点会驱动很多矿机，一个矿池有一个矿主，叫 pool manager，下面连了很多矿工，这些矿工只负责计算哈希值，全节点的其他职责都由矿主来承担。他负责监听网上的交易，把这些交易组织打包成区块。

==矿池的出现还为了解决另一个问题：收入不稳定，单个矿工的收入是不稳定的，所以大家一起干，有了收益再进行分配==。



### 矿工如何分配收益
矿工要加入一个矿池，就是按照矿池规定的通讯协议跟矿主进行联系。矿主把计算哈希值的任务分配给他，矿工计算完之后，把结果反馈给矿主，将来获得出块奖励时一起分配。

利益该怎么分配？平均分配行不行？比如每个矿工挖到一个区块，得到了出块奖励，然后平分给其他矿工，这样行吗？不行，因为会有矿工偷懒。因此要按矿工的贡献大小进行分配，也就是这里同样需要==工作量证明==。那该怎么证明每个矿工做了多少工作呢？



为什么矿工的收入不稳定，因为挖矿太难了，如果把挖矿的难度降低之后，挖矿就会变得稳定了。怎么降低难度呢？以前的要求是前面至少有 70 个 0 才是合法的区块。降低挖矿难度之后，比如说前面只要有 60 个 0 就行了，这样挖到的叫作一个 share，这个 share 叫做 almost valid block。矿工挖到一个 share 之后，把它提交给矿主。==矿主拿到这个区块有什么用呢？用来证明矿工所做的工作量，而没有其他用途==，矿主无法得到区块奖励以及任何好处。所以矿主就统计每个矿工提交了多少这样的share，将来等到某个矿工真正挖到了合法的区块之后，再将出块奖励按照每个矿工所做的工作量，提交的 share 数目进行分配。



* **矿工挖到区块后不提交给矿主，自己发布，能不能行？**
  不行，因为区块里的 coinbase transaction 的==收款地址是矿主的==，如果改了收款地址呢？
  也不行，==改了之后 默克尔树 根 hash 值变化==。

* 如果挖到了不提交直接丢弃呢？
  潜入竞争对手的矿池，不想让这个矿池得到区块奖励。这些矿工还是会分红，分的是别的矿工挖出来的区块奖励

### 51% 攻击

一般来说，矿池的矿主要收取一定比例的出块奖励作为管理费。矿主也要按照比例收取管理费，有的是按照出块奖励的比例，也有的是抽取交易费。有的一些有恶意的矿池在发动攻击之前，可能故意把管理费降得特别低，甚至是赔本赚吆喝，吸引足够多的矿工加入之后就可以发动攻击了。这是大型矿池的一个弊端，使得51%的攻击更加容易了。

矿池让 51% 攻击更容易，假设有矿池占了 51% 的算力，能发动哪些攻击？

1. ==分叉攻击==：A -转账-> B，等 6 个区块 B 确认后，发动分叉，再把钱转给自己
2. ==**Boycott**==（封锁禁用）：禁用某些账户，不打包 A 的交易，只要出现 A 的交易，马上分叉，把 A 的交易剔除，因为自己算力大，这个分叉链很快会成为最长链。其他矿工也不敢把 A 打包进去，因为一大包就会被分叉，自己的工作就白费了
3. ==不能把其他账户的钱花了，因为没有私钥签名，如果强行把这个区块大包进去呢？会分叉，诚实节点会沿着另一个分叉继续挖==