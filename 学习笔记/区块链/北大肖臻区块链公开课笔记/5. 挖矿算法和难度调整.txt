# 挖矿难度

挖矿就是不断尝试 block header 里的 nonce 值，使 H(block header) <= target，target 越小，难度越大。调整挖矿难度就是调整目标空间在整个输出空间中所占的比例。



比特币用的哈希算法是 SHA-256，这个产生的哈希值是 256 位。所以整个输出空间是 2 的 256 次方。调整这个比例，即目标空间占输出空间的比例，通俗的说，就是哈希值前面要有多少个 0。比如说 256 位的哈希值，要是合法的区块，要求算出来的哈希，前面至少有 70 个 0。



挖矿的难度跟目标阈值是成反比的，公式是：difficulty = difficulty_1_target / target（difficulty_1_target 是指挖矿难度等于 1 的时候所对应的目标阈值，挖矿难度最小就是 1，这个时候对应的目标阈值是个非常大的数）。

## 为什么要调整挖矿难度

为什么要调整挖矿难度？系统里的总算力越来越强，挖矿难度保持不变的话，出块时间是越来越短的。出块时间太小有什么问题？

比如说不到 1 秒就出一个区块，区块在网络上传播的时间可能需要几十秒，底层的比特币网络可能需要几十秒才能让其他节点都收到。别的节点没有收到这个区块之前还是继续沿着已有的区块链往下扩展。如果有两个节点同时都发布一个区块，这个时候就会出现分岔。

因此==出块时间短会导致**分叉会非常频繁**，而且会出现多分叉，对系统达成共识不好，安全性也不好。==



==分叉多了以后，**算力分散**，**分叉攻击更容易**。有恶意的节点可以集中算力在分叉链上扩展，不需要 51% 的算力就可以发动攻击。==

<img src="https://littleneko.oss-cn-beijing.aliyuncs.com/img/image-20221017233343216.png" alt="image-20221017233343216" style="zoom:25%;" />



那 10 分钟的出块时间是不是最优的呢？不一定，改成其他值也可以，有间隔只是说应该有个常数范围。以太坊出块时间 15s，出块时间大幅度下降之后，以太坊就要设计新的协议，叫 ghost。

> 在 ghost 协议中，这些分叉产生的 orphan block（即产生最长合法链后另一个要被丢弃的区块）就不能丢弃掉了，而是也要给它们一些奖励，这叫 uncle reward。以太坊也要调整挖矿难度，使出块时间保持在 15s。

## 如何调整挖矿难度

比特币中每 2016 个区块需要调整一次难度，即 (2016 x 10) / (60 x 24) = 14 天，调整公式是：

new_target = target x (actual_time / expected_time) （有最大 4 倍限制，和最小 1/4 限制）



* 如何让所有矿工同时调整难度？

  规则写在代码里，每过 2016 个区块就会自动调整。

* 如果有恶意节点修改代码不调整怎么办？

  header 中有 nBits 表示 target，其他节点会这个区块式非法的，不会接受。



# 挖矿

全节点 轻节点
ppt：http://zhenxiao.com/blockchain/08-BTC.pdf


如果在挖矿过程中收到一个区块，且是合法的并且在延伸最长合法链，应该停止现在正在挖的区块，然后重新在本地组装一个候选区块，然后开始挖矿。要沿着新收到的最长合法链挖，本地区块可能会发生变化，因为有些区块可能已经被包含在这个最新的最长合法链中了，而且 block header 中的 previous block hash 和 默克尔树都会发生变化。


放弃已经在挖的区块，去挖新的区块，前面做的工作都白费了。

但是因为 计算 hash 值的 无记忆性，实际上不会有影响，只要没挖出来，期望挖到的时间仍然是 10 分钟


========================

比特币如何保证安全性
1. 密码学上保证，无法伪造签名，没有私钥签名不能花掉 btc（系统中大多数矿工是诚实的）
2. 共识机制

=========================
挖矿设备
1. 通用设备（CPU）：只用到整数运算，内存等都没怎么用到
2. GPU：仍然只用到 整数运算，其他的部件浪费
3. ASIC：专用芯片，为某个（几个）加密货币设计，不通用 mining puzzle


矿池
单个矿工的问题，算力很小，平均需要挖很长时间才能挖到一个区块

poll manager 下连接很多矿机
poll manager 实现全节点的功能，矿机只计算 hash

矿工如何分配收益？
需要有工作量证明。

降低难度，挖到的叫一个 share（almost valid block）
矿工挖到这个区块后，提交给矿主，矿主拿到后没有任何用处，只是用来记录每个矿工的工作量

矿工挖到区块后不提交给矿主，自己发布，能不能行？
不行，因为区块里的收款地址是矿主的，如果改了收款地址呢？
也不行，改了之后 默克尔树 根 hash 值变化


如果挖到了不提交直接丢弃呢？
潜入竞争对手的矿池，搞破坏

矿池让 51% 攻击更容易

===========================
假设有矿池占了 51% 的算力，能发动哪些攻击？

1. 分叉攻击：A -转账-> B，等 6 个区块 B 确认后，发动分叉，再把钱转给自己
2. Boycott（封锁禁用）：禁用某些账户，不打包 A 的交易，只要出现 A 的交易，马上分叉，把 A 的交易剔除，因为自己算力大，这个分叉链很快会成为最长链。其他矿工也不敢把 A 打包进去，因为一大包就会被分叉，自己的工作就白费了
3. 不能把其他账户的钱花了，因为没有私钥签名，如果强行把这个区块大包进去呢？会分叉，诚实节点会沿着另一个分叉继续挖