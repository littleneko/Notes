数字货币发行

方案一：央行发行，每一张数字货币都由央行使用私钥签名，花钱时每个人用公钥验证

问题：双重支付（double spending attack），数字货币发行由央行决定

改进方案：每一张数字货币都有编号，央行记录每一张数字货币在谁手里

问题：每次支付都要通过央行，太复杂


去中心化货币需要解决的两个问题：
1. 谁来发行：BTC 使用挖矿
2. 双重支付问题：区块链

TODO
图 1（简化，每个区块只有一个交易）

每个交易需要有
1. A 的私钥签名：证明这个交易是 A 发起的
2. 输入：说明币的来源，防范 double spending
3. 输出：说明收款人公钥的 hash


所有节点都需要知道 A 的公钥，为了验证 A 的签名是正确的

如何知道 A 的公钥？
在转账交易中由 A 自己给出，记录在转账交易中

问题：有人冒名顶替 A，自己生成一对公私钥，记录在交易中

如何避免这个问题？
每个输出中记录了公钥的 hash，如果有人冒充 A，币的来源中的公钥 hash 和交易中的公钥 hash 验证不通过


===========

Block Header
* version
* hash of previous block header: 注意值计算 header 的 hash
* merkle root hash: 保证 block body 里包含的交易没有被篡改
* time
* target: 挖矿难度
* nonce: 随机数用来挖矿

Block Body
* transaction list


区块链中的两类节点
* 全节点（full node）
* 轻节点（light node）: 只保留 block header 的信息，无法独立验证交易的合法性


===========
交易如何写到区块链中，如何保证一致性

BTC 中的共识协议需要解决恶意节点的问题

方案 1：投票决定，半数以上通过就接受
问题：谁有投票权？（联盟链是特定账户才有投票权）。女巫攻击（sybil attack），产生大量公私钥，超过总数一半

解决方案：POW（挖矿），按算力投票
找到 Hash(block header) <= target 的节点获得记账权，可以把交易写到区块中并发布到网络中，其他节点收到这个区块后需要验证区块的合法性
区块合法性：每个交易是合法的（使用的币没有被花过，签名正确，block header 验证通过）

是否有可能验证通过也不接受区块？
可能，分叉的情况，最长合法链原则

* 分叉攻击（forking attack）

区块链正常情况下也可能发生分叉：两个节点几乎同时找到了符合要求的 nonce，获得了记账权
默认每个节点接受最早收到的区块，沿着这个链继续向下扩展（挖矿），出现的分叉只是临时的，但最终只会有一个链生出（最长链）

=============
节点为什么要记账？

出块奖励：coinbase transaction，发行新 BTC 的唯一方法

初始 50 BTC，每过 21 万个区块减半

